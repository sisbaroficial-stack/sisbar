{% extends 'base.html' %}

{% block title %}Descontar Producto - SISBAR {% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Encabezado -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2 mb-1">ðŸ“¤ Descontar Producto</h1>
            <p class="text-muted">Registra salidas de inventario</p>
        </div>
    </div>
    
    <div class="row">
        <!-- Formulario de descuento -->
        <div class="col-lg-6 mb-4">
            <div class="card card-custom border-0">
                <div class="card-body p-4">
                    <div class="alert alert-info mb-4">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Tip:</strong> Escanea el cÃ³digo de barras o escribe el cÃ³digo del producto.
                    </div>
                    
                    <form method="post" id="formDescontar">
                        {% csrf_token %}
                        
                        <div class="mb-4">
                            <label for="{{ form.codigo.id_for_label }}" class="form-label fw-semibold fs-5">
                                <i class="bi bi-upc-scan me-2"></i>CÃ³digo del Producto
                            </label>
                            {{ form.codigo }}
                            {% if form.codigo.errors %}
                                <div class="text-danger small mt-1">{{ form.codigo.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <!-- InformaciÃ³n del producto (se mostrarÃ¡ dinÃ¡micamente) -->
                        <div id="productoInfo" class="mb-4" style="display: none;">
                            <div class="alert alert-success">
                                <h6 class="mb-3"><strong>âœ… Producto Encontrado</strong></h6>
                                <div id="productoDetalles"></div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="{{ form.cantidad.id_for_label }}" class="form-label fw-semibold fs-5">
                                <i class="bi bi-calculator me-2"></i>Cantidad a Descontar
                            </label>
                            {{ form.cantidad }}
                            {% if form.cantidad.errors %}
                                <div class="text-danger small mt-1">{{ form.cantidad.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-4">
                            <label for="{{ form.motivo.id_for_label }}" class="form-label fw-semibold">
                                <i class="bi bi-pencil me-2"></i>Motivo (Opcional)
                            </label>
                            {{ form.motivo }}
                            {% if form.motivo.errors %}
                                <div class="text-danger small mt-1">{{ form.motivo.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <button type="submit" class="btn btn-gradient w-100 py-3 fs-5">
                            <i class="bi bi-arrow-down-circle me-2"></i>
                            Descontar Producto
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Ayuda -->
            <div class="card card-custom border-0 mt-4">
                <div class="card-body">
                    <h6 class="fw-bold mb-3">ðŸ’¡ GuÃ­a RÃ¡pida</h6>
                    <ol class="mb-0">
                        <li class="mb-2">Escanea o escribe el cÃ³digo del producto</li>
                        <li class="mb-2">Verifica que sea el producto correcto</li>
                        <li class="mb-2">Ingresa la cantidad a descontar</li>
                        <li class="mb-2">Opcionalmente, agrega un motivo</li>
                        <li>Presiona "Descontar Producto"</li>
                    </ol>
                </div>
            </div>
        </div>
        
        <!-- Ãšltimos movimientos -->
        <div class="col-lg-6">
            <div class="card card-custom border-0">
                <div class="card-header bg-transparent border-0 pt-4">
                    <h5 class="mb-0">ðŸ“‹ Ãšltimas Salidas</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Usuario</th>
                                    <th>Fecha</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if ultimos_movimientos %}
                                    {% for mov in ultimos_movimientos %}
                                    <tr>
                                        <td>
                                            <strong>{{ mov.producto.nombre }}</strong>
                                            <br><small class="text-muted">{{ mov.producto.codigo }}</small>
                                        </td>
                                        <td>
                                            <span class="badge bg-danger">
                                                -{{ mov.cantidad }}
                                            </span>
                                        </td>
                                        <td>
                                            <small>{{ mov.usuario.username }}</small>
                                        </td>
                                        <td>
                                            <small>{{ mov.fecha|date:"d/m/Y H:i" }}</small>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr>
                                        <td colspan="4" class="text-center text-muted">
                                            No hay movimientos recientes
                                        </td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Buscar producto en tiempo real
    const codigoInput = document.querySelector('input[name="codigo"]');
    const productoInfo = document.getElementById('productoInfo');
    const productoDetalles = document.getElementById('productoDetalles');
    
    let timeoutId;
    
    codigoInput.addEventListener('input', function() {
        clearTimeout(timeoutId);
        
        const codigo = this.value.trim();
        
        if (codigo.length >= 3) {
            timeoutId = setTimeout(() => {
                buscarProducto(codigo);
            }, 500);
        } else {
            productoInfo.style.display = 'none';
        }
    });
    
    function buscarProducto(codigo) {
        fetch(`/inventario/buscar-ajax/?codigo=${encodeURIComponent(codigo)}`)
            .then(response => response.json())
            .then(data => {
                if (data.encontrado) {
                    const p = data.producto;
                    productoDetalles.innerHTML = `
                        <div class="row">
                            <div class="col-6"><strong>Nombre:</strong></div>
                            <div class="col-6">${p.nombre}</div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-6"><strong>CategorÃ­a:</strong></div>
                            <div class="col-6">${p.categoria}</div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-6"><strong>Stock Actual:</strong></div>
                            <div class="col-6"><strong class="text-${p.estado_color}">${p.cantidad} ${p.unidad_medida}</strong></div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-6"><strong>Estado:</strong></div>
                            <div class="col-6"><span class="badge bg-${p.estado_color}">${p.estado}</span></div>
                        </div>
                    `;
                    productoInfo.style.display = 'block';
                } else {
                    productoInfo.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
    
    // Auto-focus en cÃ³digo despuÃ©s de enviar
    document.getElementById('formDescontar').addEventListener('submit', function() {
        setTimeout(() => {
            codigoInput.focus();
            codigoInput.select();
        }, 100);
    });
</script>
{% endblock %}